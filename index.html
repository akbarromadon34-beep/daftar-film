<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üé¨ Movie Index</title>
<style>
  body {font-family:'Segoe UI',Arial,sans-serif;background-color:#16002b;color:#fff;margin:0;padding:0;}
  header{background:linear-gradient(90deg,#6a0dad,#9b30ff);padding:15px 25px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 3px 10px rgba(0,0,0,0.3);flex-wrap:wrap;}
  header h1{margin:0;font-size:1.8em;letter-spacing:0.5px;display:flex;align-items:center;gap:8px;}
  .controls{display:flex;gap:10px;align-items:center;}
  #search,#folderSelect,#typeSelect{padding:8px 12px;border:none;border-radius:8px;font-size:1em;outline:none;}
  #folderSelect,#typeSelect{background:#fff;color:#333;}
  #progressBarContainer{position:fixed;top:0;left:0;width:100%;height:4px;background:rgba(255,255,255,0.1);z-index:999;}
  #progressBar{height:4px;width:0%;background:#ff66ff;transition:width 0.3s;}
  .container{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:18px;padding:25px;}
  .card{background:#250045;border-radius:12px;box-shadow:0 5px 10px rgba(0,0,0,0.3);overflow:hidden;display:flex;flex-direction:column;transition:transform 0.2s,box-shadow 0.2s;}
  .card:hover{transform:scale(1.03);box-shadow:0 8px 18px rgba(0,0,0,0.5);}
  .card img{width:100%;height:380px;object-fit:cover;background:#111;}
  .card-content{padding:12px 15px;flex:1;display:flex;flex-direction:column;}
  .card h3{font-size:1em;margin:8px 0 5px;}
  .card p{margin:0;font-size:0.9em;color:#ccc;}
  .download{margin-top:auto;text-align:center;}
  .download a{display:inline-block;margin-top:10px;padding:8px 15px;background:#9b30ff;border-radius:6px;color:#fff;text-decoration:none;transition:background 0.2s;}
  .download a:hover{background:#b84fff;}
  .empty{text-align:center;padding:50px;color:#aaa;}
  @media(max-width:600px){header{flex-direction:column;align-items:flex-start;gap:10px;}.controls{flex-direction:column;width:100%;}#search,#folderSelect,#typeSelect{width:100%;}}
</style>
</head>
<body>

<div id="progressBarContainer"><div id="progressBar"></div></div>

<header>
  <h1>üé¨ Movie Index</h1>
  <div class="controls">
    <select id="typeSelect">
      <option value="all">All</option>
      <option value="movie">Movies</option>
      <option value="tv">Series</option>
    </select>
    <select id="folderSelect">
      <option value="">All Categories</option>
      <option value="1FOLDER_ID_AMZN">Amazon</option>
      <option value="1FOLDER_ID_NF">Netflix</option>
    </select>
    <input type="text" id="search" placeholder="Search movies...">
  </div>
</header>

<div class="container" id="movies"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwSoVNuzbgC82WJ9UzSU-nCIo4JIiP1Av-qPdpjWzbcC4LJPrMwooQVfCFkotbL2voVfA/exec";
const OMDB_API_KEY = "406b9b64";
const TMDB_API_KEY = "d15ed461116703666fe13069e7f5341c";
const posterCache = {};

function setProgress(percent){document.getElementById("progressBar").style.width=percent+"%";}

async function fetchMovies(url=SCRIPT_URL){
  setProgress(10);
  const res=await fetch(url);
  setProgress(40);
  const files=await res.json();
  setProgress(70);
  await renderMovies(files);
  setProgress(100);
  setTimeout(()=>setProgress(0),800);
}

function cleanTitleForSearch(title){
  return title
    .replace(/\(.*?\)/,"")
    .replace(/S\d{1,2}E\d{1,2}.*/i,"")
    .replace(/\b\d{4}\b/,"")
    .replace(/\b(1080p|720p|WEB[-_. ]?DL|WEBRip|HDRip|BluRay|NF|AMZN|DDP5\.1|H\.264|x264|UCUP|APRT|Atmos|UCU[P]?|NFWEB)\b/gi,"")
    .replace(/\./g," ")
    .replace(/\s{2,}/g," ")
    .trim();
}

async function getPoster(title, filterType="all"){
  if(posterCache[title]) return posterCache[title];
  const cleanTitle=cleanTitleForSearch(title);

  // --- 1Ô∏è‚É£ OMDb dulu ---
  try{
    const omdbRes=await fetch(`https://www.omdbapi.com/?t=${encodeURIComponent(cleanTitle)}&apikey=${OMDB_API_KEY}`);
    const omdbData=await omdbRes.json();
    if(omdbData.Poster && omdbData.Poster!=="N/A"){
      posterCache[title]=omdbData.Poster;
      return omdbData.Poster;
    }
  }catch(e){}

  // --- 2Ô∏è‚É£ TMDb film + tv ---
  try{
    let moviePoster=null, tvPoster=null;
    const movieRes=await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(cleanTitle)}`);
    const movieData=await movieRes.json();
    if(movieData.results?.length>0) moviePoster=movieData.results[0].poster_path;

    const tvRes=await fetch(`https://api.themoviedb.org/3/search/tv?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(cleanTitle)}`);
    const tvData=await tvRes.json();
    if(tvData.results?.length>0) tvPoster=tvData.results[0].poster_path;

    let posterPath=null;
    if(filterType==="movie") posterPath=moviePoster;
    else if(filterType==="tv") posterPath=tvPoster;
    else posterPath=moviePoster || tvPoster;

    if(posterPath){
      const url=`https://image.tmdb.org/t/p/w500${posterPath}`;
      posterCache[title]=url;
      return url;
    }
  }catch(e){}

  posterCache[title]="https://via.placeholder.com/300x450?text=No+Image";
  return posterCache[title];
}

async function renderMovies(files){
  const container=document.getElementById("movies");
  container.innerHTML="";
  if(!files||files.length===0){container.innerHTML=`<div class="empty">No movies found</div>`;return;}

  const filterType=document.getElementById("typeSelect").value;
  let count=0;
  for(const file of files){
    count++;
    if(count%5===0)setProgress((count/files.length)*100);

    const cleanName=file.name.replace(/\.[^/.]+$/,"");
    const parts=cleanName.split(/[.\s_-]+/);
    const yearIndex=parts.findIndex(p=>/^\d{4}$/.test(p));
    let title="",year="";
    if(yearIndex!==-1){title=parts.slice(0,yearIndex).join(" ");year=parts[yearIndex];}
    else{title=cleanName.replace(/\./g," ");}
    const displayName=year?`${title} (${year})`:title;

    const poster=await getPoster(file.name, filterType);
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <img src="${poster}" alt="${displayName}">
      <div class="card-content">
        <h3>${displayName}</h3>
        <p>${file.size} ‚Äî ${file.folderName}</p>
        <div class="download">
          <a href="${file.url}" target="_blank">‚¨áÔ∏è Download</a>
        </div>
      </div>
    `;
    container.appendChild(card);
  }
}

document.getElementById("search").addEventListener("input",e=>{
  const val=e.target.value.toLowerCase();
  document.querySelectorAll(".card").forEach(card=>{
    card.style.display=card.textContent.toLowerCase().includes(val)?"":"none";
  });
});

document.getElementById("folderSelect").addEventListener("change",async e=>{
  const folderId=e.target.value;
  const url=folderId?`${SCRIPT_URL}?folderId=${folderId}`:SCRIPT_URL;
  await fetchMovies(url);
});

document.getElementById("typeSelect").addEventListener("change",async()=>{
  await fetchMovies();
});

fetchMovies();
</script>
</body>
</html>
